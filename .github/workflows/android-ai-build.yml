name: Auto Build, AI-Fix & Multi Project Build

on:
  push:
    branches: [ "main" ]
  pull_request:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  run-all:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          python -m pip install --upgrade pip
          pip install google-genai

      - name: Find projects
        id: find-projects
        run: |
          projects=""
          # Flutter projects
          for f in $(find . -name "pubspec.yaml"); do
            projects="$projects|flutter:$(dirname "$f")"
          done
          # Gradle projects
          for f in $(find . -name "build.gradle" -o -name "build.gradle.kts"); do
            if [[ "$f" == *"/app/"* ]]; then
              projects="$projects|gradle:$(dirname "$f")"
            fi
          done
          # Node projects
          for f in $(find . -name "package.json"); do
            projects="$projects|node:$(dirname "$f")"
          done
          # Python projects
          for f in $(find . -name "requirements.txt"); do
            projects="$projects|python:$(dirname "$f")"
          done

          projects=${projects#|}
          echo "PROJECTS=$projects" >> $GITHUB_ENV
          echo "Found projects: $projects"

      - name: Run AI auto-fixer
        id: ai-fix
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„ÙƒØªÙ„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©!
          # Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒÙˆØ¯ Ø¨Ø§ÙŠØ«ÙˆÙ† Ù‡Ù†Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„Ø¢Ù†.
          # ÙÙ‚Ø· Ø£Ù…Ø± Bash Ù„ØªØ´ØºÙŠÙ„ Ù…Ù„Ù ai_fix_all.py
          mkdir -p .github/scripts
          python .github/scripts/ai_fix_all.py 2>&1 | tee .github/ai_report.txt

          report_content=$(cat .github/ai_report.txt)
          echo "report<<EOF" >> $GITHUB_OUTPUT
          echo "$report_content" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          branch: ai-fix-${{ github.run_id }}
          title: "ğŸ¤– AI suggested fixes"
          commit-message: "ğŸ¤– AI applied automatic fixes"
          body: ${{ steps.ai-fix.outputs.report }}

      - name: Checkout AI branch if exists
        run: |
          BRANCH_NAME="ai-fix-${{ github.run_id }}"
          if git show-ref --verify --quiet "refs/heads/$BRANCH_NAME" || git show-ref --verify --quiet "refs/remotes/origin/$BRANCH_NAME"; then
            git checkout "$BRANCH_NAME"
          else
            echo "AI branch not found; continuing on current branch"
          fi

      - name: Build projects
        run: |
          set -e
          mkdir -p artifacts
          if [ -z "$PROJECTS" ]; then
            echo "No projects found"
            exit 0
          fi
          IFS='|' read -ra PROJECT_ARRAY <<< "$PROJECTS"
          for project in "${PROJECT_ARRAY[@]}"; do
            type="${project%%:*}"
            path="${project#*:}"
            cd "$path" || continue
            case $type in
              flutter)
                flutter pub get || true
                flutter analyze || true
                flutter test || true
                flutter build apk --release || true
                mkdir -p "../../artifacts/flutter/$(basename "$path")"
                cp build/app/outputs/flutter-apk/app-release.apk "../../artifacts/flutter/$(basename "$path")/" 2>/dev/null || true
                ;;
              gradle)
                chmod +x gradlew || true
                ./gradlew assembleRelease || true
                mkdir -p "../../artifacts/gradle/$(basename "$path")"
                cp app/build/outputs/apk/release/*.apk "../../artifacts/gradle/$(basename "$path")/" 2>/dev/null || true
                ;;
              node)
                npm install || true
                npm run build || true
                mkdir -p "../../artifacts/node/$(basename "$path")"
                cp -r dist/* "../../artifacts/node/$(basename "$path")/" 2>/dev/null || true
                ;;
              python)
                pip install -r requirements.txt || true
                pytest || true
                mkdir -p "../../artifacts/python/$(basename "$path")"
                cp -r build/* "../../artifacts/python/$(basename "$path")/" 2>/dev/null || true
                ;;
            esac
            cd - >/dev/null
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: artifacts/
          if-no-files-found: ignore
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          # Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ ÙŠÙ…Ù†Ø­ ØµÙ„Ø§Ø­ÙŠØ§Øª ÙƒØ§ÙÙŠØ© Ù„Ù„ØªÙˆÙƒÙ† Ù„Ø¥Ù†Ø´Ø§Ø¡ PRs
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ai-fix-${{ github.run_id }}
          title: "ğŸ¤– AI suggested fixes"
          commit-message: "ğŸ¤– AI applied automatic fixes"
          body: ${{ steps.ai-fix.outputs.report }}
    ```
    **Ù…Ù„Ø§Ø­Ø¸Ø©:** Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† `GITHUB_TOKEN` Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ù„Ø¯ÙŠÙƒ Ù„Ø¯ÙŠÙ‡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨. Ø¹Ø§Ø¯Ø©Ù‹ Ù…Ø§ ÙŠÙƒÙˆÙ† `contents: write` Ùˆ `pull-requests: write` ÙÙŠ Ù‚Ø³Ù… `permissions` ÙƒØ§ÙÙŠÙŠÙ†ØŒ ÙˆÙ„ÙƒÙ† Ø¥Ø°Ø§ Ø§Ø³ØªÙ…Ø±Øª Ø§Ù„Ù…Ø´ÙƒÙ„Ø©ØŒ Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ© Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ùƒ (Settings > Actions > General > Workflow permissions).

**Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„ÙÙŠÙ† Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø©. Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ (YAML Syntax) Ù‡ÙŠ Ø¹Ù‚Ø¨Ø© Ø£Ø³Ø§Ø³ÙŠØ© ÙŠØ¬Ø¨ ØªØ¬Ø§ÙˆØ²Ù‡Ø§ Ù‚Ø¨Ù„ Ø£ÙŠ Ø´ÙŠØ¡ Ø¢Ø®Ø±.**
Use Arrow Up and Arrow Down to select a turn, Enter to jump to it, and Escape to return to the chat.
Start typing a prompt
