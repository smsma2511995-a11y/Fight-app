name: Build, Analyze and AI Review

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  # 🔍 تحليل الكود
  codeql:
    name: Static Code Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, python, java
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # 🤖 مراجعة بالكود من StarCoder
  ai-review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: pip install transformers torch
      - name: Run AI Review with StarCoder
        run: |
          python - <<'EOF'
          from transformers import AutoModelForCausalLM, AutoTokenizer
          import os

          model_id = "bigcode/starcoder"
          tokenizer = AutoTokenizer.from_pretrained(model_id)
          model = AutoModelForCausalLM.from_pretrained(model_id)

          prompt = "راجع الكود وابين الاخطاء واقتراحات التحسين"
          inputs = tokenizer(prompt, return_tensors="pt")
          outputs = model.generate(**inputs, max_new_tokens=200)
          print("🔎 AI Review Result:\n")
          print(tokenizer.decode(outputs[0], skip_special_tokens=True))
          EOF

  # 📱 بناء APK للتطبيق
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
      - name: Install dependencies
        run: flutter pub get
      - name: Build APK
        run: flutter build apk --release
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: build/app/outputs/flutter-apk/app-release.apk
